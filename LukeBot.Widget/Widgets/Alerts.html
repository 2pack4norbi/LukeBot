<!DOCTYPE html>

<link href="https://fonts.googleapis.com/css2?family=Open+Sans" rel="stylesheet">

<style>
    body {
        background-color: rgba(0, 0, 0, 255);
        overflow: hidden;
        color: #ffffff;
        font-family: 'Open Sans' Arial sans-serif;
    }
</style>

<div id="alert">
</div>

<script>
    const dbg = document.getElementById("debug");
    function printDebug(text) {
        if (dbg) {
            dbg.innerHTML += text + "<br />";
        }
        console.log(text);
    }

    const metadata = document.getElementsByTagName('meta');
    function getMeta(name) {
        for (let i = 0; i < metadata.length; ++i) {
            if (metadata[i].getAttribute('name') === name) {
                return metadata[i].getAttribute('content');
            }
        }
        return '';
    }

    class WidgetEventCompletionStatus {
        constructor(status, reason) {
            this.Status = status;
            this.Reason = reason;
        }

        send(socket) {
            socket.send(JSON.stringify(this))
        }
    }

    class AlertBase {
        constructor(receivedObject) {
            if (this.constructor == Animal) {
                throw new Error("Cannot instantiate base class");
            }

            this.mType = receivedObject.EventName;
            this.mUsername = receivedObject.User;
            this.mDisplayName = receivedObject.DisplayName;
        }

        play() {
            throw new Error("play() has not been implemented");
        }
    }

    class ChannelPointAlert extends AlertBase {
        constructor(receivedObject) {
            super(receivedObject);
            this.mTitle = receivedObject.Title;
        }

        play() {

        }
    }

    class SubscriptionAlert extends AlertBase {
        constructor(receivedObject) {
            super(receivedObject);
            this.mTitle = receivedObject.Title;
        }

        play() {

        }
    }

    const serverAddress = getMeta('serveraddress');
    const alert = document.getElementById('alert');
    printDebug(serverAddress);


    let socket = new WebSocket(serverAddress);
    socket.onopen = function (e) {
        printDebug(`Connected to server at ${serverAddress}`);
    }

    socket.onclose = function (event) {
        if (event.wasClean) {
            printDebug(`Connection closed cleanly`);
        } else {
            printDebug(`Connection died`);
        }
    }

    socket.onerror = function (error) {
        printDebug(`Error: ${error.message}`);
    }

    socket.onmessage = function (event) {
        try {
            let obj = JSON.parse(event.data);

            if (obj.EventName != null) {
                // TODO
                completionStatus = new WidgetEventCompletionStatus(0, "OK");
                completionStatus.send(socket);
            } else {
                printDebug(`Received unknown obj: ${obj}`);
            }
        } catch (error) {
            printDebug(`Error: ${error}`);
        }
    }
</script>
