<!DOCTYPE html>

<script src="/js/lukebot-widget-common.js"></script>

<style>
    body {
        background-color: rgba(0, 0, 0, 0);
        margin: 0px;
        overflow: hidden;
        white-space: nowrap;
        color: #ffffff;
        font: 48px Arial;
        text-shadow: black 0px 0px 2px, black 0px 0px 2px, black 0px 0px 2px, black 0px 0px 2px, black 0px 0px 2px;
    }

    .main-div {
        float: left;
        clear: none;
    }

    .album-image-container {
        position: relative;
        float: left;
        padding-right: 8px;
        display: inline;
    }

    .album-image {
        position: relative;
        max-height: 165px;
    }

    .album-image-pause-backdrop {
        position: absolute;
        top: 0px;
        left: 0px;
        background-color: #00000000;
        backdrop-filter: "none";
        transition: background-color 0.5s ease-in-out 0.1s, backdrop-filter 0.5s ease-in-out 0.1s;
    }

    .album-image-pause-icon {
        position: absolute;
        top: 0px;
        left: 0px;
        transform: "scale(0, 0)";
        transition: transform 0.6s ease-in-out;
    }

    .now-playing-data-container {
        position: relative;
        overflow: hidden;
    }

    #title {
    }

    #artists {
    }

    #label {
    }

    .field-margin {
        margin-right: 50px;
    }

    #debug {
        font: 16px Arial;
        white-space: normal;
        color: #ffffff;
    }
</style>
<div class="main-div">
<div id="albumImageContainer" class="album-image-container">
    <img id="albumImage" class="album-image" src="">
    <div id="albumImagePauseBackdrop" class="album-image-pause-backdrop"></div>
    <img id="albumImagePauseIcon" class="album-image-pause-icon" style="display: none" width="40" height="40" src="/content/pause.svg">
</div>
<div id="nowPlayingContainer" class="now-playing-data-container">
    <div id="title">
        <span id="subTitleMain" class="field-margin">Title</span><span id="subTitleExtra"></span>
    </div>
    <div id="artists">
        <span id="subArtistsMain" class="field-margin">Artists</span><span id="subArtistsExtra"></span>
    </div>
    <div id="label">
        <span id="subLabelMain" class="field-margin">[Label]</span><span id="subLabelExtra"></span>
    </div>
</div>
</div>
<!-- Debugging section - commented out in release code
<br />
<div>
    Debug logs:<br />
</div>
<div id="debug" class="debug">
</div>
-->

<script>
    const artists = document.getElementById('artists');
    const subArtistsMain = document.getElementById('subArtistsMain');
    const subArtistsExtra = document.getElementById('subArtistsExtra');
    let subArtistsMainStyle = window.getComputedStyle(subArtistsMain);

    const title = document.getElementById('title');
    const subTitleMain = document.getElementById('subTitleMain');
    const subTitleExtra = document.getElementById('subTitleExtra');
    let subTitleMainStyle = window.getComputedStyle(subTitleMain);

    const label = document.getElementById('label');
    const subLabelMain = document.getElementById('subLabelMain');
    const subLabelExtra = document.getElementById('subLabelExtra');
    let subLabelMainStyle = window.getComputedStyle(subLabelMain);

    const nowPlayingDiv = document.getElementById('nowPlayingContainer');

    let imageSpan = document.getElementById('albumImageContainer');
    let image = document.getElementById('albumImage');
    let pauseBackdrop = document.getElementById('albumImagePauseBackdrop');
    let pauseImage = document.getElementById('albumImagePauseIcon');

    const STATE_UNLOADED = 0;
    const STATE_STOPPED = 1;
    const STATE_PLAYING = 2;
    let oldPlaybackState = STATE_UNLOADED;
    let playbackState = STATE_UNLOADED;
    let currentTrack = null;
    let trackChanged = false;
    function AnimState(divElement, mainElement, extraElement, mainElementStyle) {
        this.divElement = divElement;
        this.mainElement = mainElement;
        this.extraElement = extraElement;
        this.mainElementStyle = mainElementStyle;
        this.offset = 0.0; // px
        this.speed = 25.0; // px/s
        this.wait = 2.0; // seconds
        this.start = undefined;
        this.lastTime = undefined;
        this.inProgress = false;
        this.animStopped = false;

        this.animStep = function (currentTime) {
            // early exit so we don't update anything by accident if animation should be over
            if (this.inProgress == false) {
                return;
            }

            if (this.start === undefined) {
                this.start = currentTime;
                this.lastTime = currentTime;
            }

            let deltaTime = (currentTime - this.lastTime) / 1000.0; // ms -> s
            let totalTime = (currentTime - this.start) / 1000.0; // ms -> s

            // only start scrolling when we waited a bit
            if (totalTime > this.wait) {
                this.offset -= deltaTime * this.speed;
                if (this.offset < (-1 * (this.mainElement.offsetWidth + parseInt(this.mainElementStyle.marginRight, 10)))) {
                    // scroll finished, restart animation
                    this.offset = 0.0;
                    this.start = currentTime;
                }
                this.divElement.style.transform = 'translateX(' + this.offset + 'px)';
            }

            this.lastTime = currentTime;
            window.requestAnimationFrame(this.animStep.bind(this));
        }

        this.updateElements = function (newContent) {
            this.mainElement.innerHTML = newContent;
            if (this.mainElement.offsetWidth > (window.innerWidth - nowPlayingDiv.offsetLeft)) {
                this.extraElement.innerHTML = newContent;
            } else {
                this.extraElement.innerHTML = "";
            }
        }

        this.checkIfAnimNeeded = function () {
            if (this.inProgress && this.mainElement.offsetWidth <= (window.innerWidth - nowPlayingDiv.offsetLeft)) {
                // shut down unneeded animation
                this.inProgress = false;
                this.divElement.style.transform = 'translateX(0px)';
                return;
            }

            this.start = undefined;
            this.offset = 0.0;
            this.divElement.style.transform = 'translateX(0px)';

            if (this.mainElement.offsetWidth > (window.innerWidth - nowPlayingDiv.offsetLeft)) {
                this.inProgress = true;
                window.requestAnimationFrame(this.animStep.bind(this));
            }
        }
    }

    let titleAnimState = new AnimState(title, subTitleMain, subTitleExtra, subTitleMainStyle);
    let artistsAnimState = new AnimState(artists, subArtistsMain, subArtistsExtra, subArtistsMainStyle);
    let labelAnimState = new AnimState(label, subLabelMain, subLabelExtra, subLabelMainStyle);

    function showPauseIcon() {
        let paddingSizeX = (image.offsetWidth / 2) - 20;
        let paddingSizeY = (image.offsetHeight / 2) - 20;
        let pausePosX = image.offsetTop + paddingSizeX;
        let pausePosY = image.offsetLeft + paddingSizeY;
        pauseImage.style.display = "block";
        pauseImage.style.padding = `${paddingSizeY}px ${paddingSizeX}px ${paddingSizeY}px ${paddingSizeX}px`;

        pauseBackdrop.style.padding = `${image.offsetHeight}px ${image.offsetWidth}px 0px 0px`;

        // transition triggers
        pauseBackdrop.style.backdropFilter = "blur(10px)";
        pauseBackdrop.style.backgroundColor = "#c5c5c57c";

        pauseImage.style.transform = "scale(1, 1)";
    }

    function hidePauseIcon() {
        pauseBackdrop.style.backdropFilter = "none";
        pauseBackdrop.style.backgroundColor = "#00000000";

        pauseImage.style.transform = "scale(0, 0)";
    }

    function updateBasedOnState() {
        if (playbackState == STATE_PLAYING) {
            titleAnimState.updateElements(currentTrack.Title);
            artistsAnimState.updateElements(currentTrack.Artists);
            labelAnimState.updateElements(currentTrack.Label);
            hidePauseIcon();
            image.style.visibility = "visible";
        } else if (playbackState == STATE_STOPPED) {
            titleAnimState.updateElements("Paused");
            artistsAnimState.updateElements("");
            labelAnimState.updateElements("");
            showPauseIcon();
            image.style.visibility = "visible";
        } else if (playbackState == STATE_UNLOADED) {
            titleAnimState.updateElements("");
            artistsAnimState.updateElements("");
            labelAnimState.updateElements("");
            image.style.visibility = "hidden";
        } else {
            titleAnimState.updateElements("INVALID STATE");
            artistsAnimState.updateElements("This should not happen");
            labelAnimState.updateElements("[definitely shouldn't]");
            image.style.visibility = "hidden";
        }

        titleAnimState.checkIfAnimNeeded();
        artistsAnimState.checkIfAnimNeeded();
        labelAnimState.checkIfAnimNeeded();
    }

    function update() {
        if (oldPlaybackState != playbackState) {
            updateBasedOnState();
        }
    }

    function updateTrack() {
        image.src = currentTrack.Image;
        image.onload = () => {
            image.onload = undefined;
            updateBasedOnState();
        }
    }

    let nowPlayingWidget = new LukeBotWidget();
    nowPlayingWidget.registerMessage("SpotifyTrackChanged", (obj) => {
        currentTrack = obj;
        updateTrack();
    });
    nowPlayingWidget.registerMessage("SpotifyStateUpdate", (obj) => {
        oldPlaybackState = playbackState;
        playbackState = obj.State;
        update();
    });
    nowPlayingWidget.registerClose(() => {
        playbackState = STATE_UNLOADED;
        update();
    });
</script>
